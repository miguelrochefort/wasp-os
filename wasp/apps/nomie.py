# SPDX-License-Identifier: LGPL-3.0-or-later
# Copyright (C) 2020 Daniel Thompson
"""Nomie client app"""

import wasp
import icons
import time

# 2-bit RLE, generated from res/nomie3.png, 2149 bytes
nomie = (
    b'\x02'
    b'`@'
    b'?\xff\xff\xff\x9f\x01@\x01A\x80\x07\x81\x81\xc0,\xc1'
    b'\xc1@2AAA\xc1\x81\x01\x02\x01\x81\xc1A\x803'
    b'\x81\xc09\xc1@:AAAAAA\xc1\x81\x802'
    b'\x81\xc0,\xc1@\x07A\x01<\x01A\x81\x803\x81\xc0'
    b':\xc1\xc1\xc1\xc1\xc6\xc1\xc1@2A\x81\xc1\xc1\xc1\xc1'
    b'\xc1\xc1\xc1\xc1\xc2\xc1\xc1\xc1\xc1\xc2\xc1\xc1\x81A\x80\x07'
    b'\x81\x015\x01\x81\xc03\xc1@:AAAAAA'
    b'AECAAAAAGAFAAAAA'
    b'\x809\x81\xc0,\xc1\x012@\x07A\x803\x81\xc0:'
    b'\xc1\xc1\xc1\xc9\xc3\xc8\xc3\xc1\xc2\xc1\xc3\xc1\xc6\xc1\xc1\xc1'
    b'\xc1@2A\x80\x07\x81.\x01A\xc1\xc1\xca\xc4\xc5\xc1'
    b'\xc2\xc1\xc7\xc1\xc1\xc1\xc2\xc2\xc1\xc1\xc4\xc1\xc1\xc1A\x01'
    b'+\x01A\xc1\xc1\xcb\xc2\xc3\xc1\xc2\xcb\xc1\xc8\xc3\xc4\xc1'
    b'\xc1\xc1\xc0,\xc1\x01)\x81@:AAJCCC'
    b'EAAAAAAAAABABADA'
    b'ADAA\x803\x81\xc0\x07\xc1(\x81AJBD'
    b'BBACAAA@\xe0A\x80\x88\x81\xc0\xef\xc1'
    b'\xc1\xc1A@:AAABAACABAD'
    b'AAA\x80,\x81&\x01\xc09\xc1AHCCC'
    b'AADAA@^A\x80\xef\x81\xc0\xd7\xc1\xc5@'
    b'\xfbA\x80\xe0\x81\xc0:\xc1\xc4\xc5\xc1\xc1\xc2\xc4\xc1\xc1'
    b'@2A\x01$\x01\xc1\xc1\xc8\xc2\xc3\xc1\xc4\xc1\xc2\xc2'
    b'\xc1\x80^\x81\xc0\xfb\xc1@\xd7E\xc1AAA\x80\xe0'
    b'\x81\xc0:\xc1\xc1\xc5\xc2\xc1\xc2\xc2\xc3\xc1\xc1\xc1@3'
    b'A\x01#\x80\x07\x81\xc1\xc1\xc6\xc1\xc1\xc4\xc1\xc4\xc1\xc1'
    b'\xc3\xc1\xc1\xc0\xfb\xc1@\xd7CAB\x80V\x81\xc0\xfc'
    b'\xc1@\xebA\x80\xd7\x81\x81\xc0\xe0\xc1@:AAA'
    b'EEAACAA\x803\x81\x01"\xc0\x07\xc1A'
    b'AFBCAAECAA@\x88A\x80\xd7\x83'
    b'\xc0\xac\xc1@\xfeA\x80\xfb\x81\x81\xc0+\xc1\x01\x01@'
    b'\xacA\x80\xd7\x81\xc0\xfb\xc1@:AABBCE'
    b'ADAA\x803\x81\x01!\xc0\x07\xc1AAEB'
    b'CBDCAAAA@\xfbA\x80\xd7\x83\xc0\xdb'
    b'\xc1\x01\x01\x01\x03@VA\x81\x81\x80^\x81\xc0:\xc1'
    b'\xc1\xc1\xc1\xc1\xc2\xc2\xc1\xc1\xc3\xc2\xc2\xc2\xc1@3A'
    b'\x01 \x80\x07\x81\xc1\xc1\xc4\xc2\xc3\xc1\xc3\xc4\xc1\xc3\xc1'
    b'\xc0^\xc1@\xd7AC\x80\xff\x81\x06\xc0\xfe\xc1B@'
    b'\xe0A\x80:\x81\x83\x81\x82\x81\x85\x82\x81\x81\x82\x82\x81'
    b'\xc02\xc1\x01\x1f@\x01A\x81\x81\x84\x82\x82\x82\x81\x81'
    b'\x81\x84\x82\x82\x81\x80^\x81\xc0\xd7\xc1\xc3@\xdbA\x06'
    b'A\xc2\x80\x88\x81\xc0:\xc1\xc5\xc1\xc2\xc3\xc5\xc2\xc2\xc1'
    b'\xc1@,A\x1f\x01\xc1\xc1\xc3\xc2\xc2\xc2\xc4\xc3\xc1\xc1'
    b'\xc1\xc2\xc1\x80^\x81\xc0\xd7\xc1\xc3@\xfbA\x80\xfc\x81'
    b'\x04\x81A\xc2\xc0\xe0\xc1@:ABABABA'
    b'BAABBBBAA\x80\x07\x81\x1f\xc03\xc1'
    b'ABAACADBBADAA@\xfbA'
    b'\x80\xd7\x84\xc0\xac\xc1@\xfeA\x01\x01\x80\xfd\x81\xc1\xc0'
    b'\xd7\xc2\xc1@^A\x80:\x81\x87\x81\x81\x81\x84\x82\x82'
    b'\x82\x82\x81\xc09\xc1\x01\x1e@,A\x81\x82\x82\x83\x84'
    b'\x83\x82\x86\x81\x80\x88\x81\xc0\xd7\xc6@\xfbAA\xc4\x80'
    b'\xef\x81\xc0:\xc2\xc6\xc1\xc1\xc2\xc1\xc2\xc3\xc1\xc3\xc2\xc1'
    b'\xc1@2A\x1e\x80\x01\x81\xc1\xc1\xc1\xc1\xc3\xc1\xc2\xc1'
    b'\xc1\xc2\xc1\xc1\xc1\xc6\xc1\xc0^\xc1@\xfbA\x80\xd7\x82'
    b'\x81\x81\x86\x81\xc0\xe0\xc1@:AAAAGAA'
    b'CCDBAA\x80\x07\x81\x1d\x01AABBA'
    b'DBAAAAEBA\xc0^\xc1@\xe0AA'
    b'\xc1\xc1\xc1A\x80\xef\x81\xc0\xfb\xc1@\xd7AA\x80\xe0'
    b'\x81\xc0:\xc1\xc1\xc1\xc3\xc6\xc1\xc1\xc1\xc2\xc4\xc3\xc2\xc1'
    b'\xc1@3A\x01\x1c\x80\x08\x81\xc09\xc1@:AA'
    b'CBAABBAFBAAAAABA'
    b'AA\x80^\x81\xc0\x88\xc1@\xe0A\x80:\x81\x81\x86'
    b'\x85\x81\x81\x81\x81\x82\x85\x82\x81\x81\x82\xc0\x07\xc1\x1b\x01'
    b'@3AA\x81\x81\x82\x82\x81\x82\x82\x81\x81\x86\x86\x87'
    b'\x81\x81\x81\x89\x86\x82\x82\x84\x81\x82\x82\x81\x81A\x01\x1a'
    b'\x80,\x81AAA\xc0:\xc1\xc1\xc1\xc1\xc4\xc1\xc1\xc2'
    b'\xc2\xc1\xc2\xc1\xc8\xc1\xc1\xc1\xc4\xc1\xc6\xc1\xc3\xc6\xc2\xc1'
    b'\xc5\xc1\xc1\xc2\xc1\xc1\xc1@\x07A\x19\x01\x809\x81\xc1'
    b'\xc03\xc1\xc1\x81@:AAABCAAAA'
    b'ABQBFAAAAAAAAAAA'
    b'BAABABAAAA\x802\x81\x19\xc0\x07'
    b'\xc1AAA@3AA\x80:\x81\x81\x81\x83\x82\x82'
    b'\x81\x81\x81\x81\x93\x83\x81\x83\x81\x81\x81A\xc02\xc1@'
    b'\x07AAA\x80,\x81\xc03\xc1@:AAAE'
    b'BBAAA\x01\x18\xc1AAAA\xc1\xc1AA'
    b'AAABAAA\x809\x81AASDAA'
    b'A\x81\xc0,\xc1@\x01A\x07\x80\x07\x81\xc02\xc1@'
    b':AADBBBA\x81\x17\x01AAAAA'
    b'A\x803\x81\x81\x81AABAA\xc09\xc1\x81A'
    b'ATDAA@,A\x01\x0b\x80\x07\x81\xc0:\xc1'
    b'\xc1\xc2\xc2\xc1\xc2\xc2\xc1@2A\x17\x80,\x81\xc1\xc4'
    b'\xc1\xc1\xc09\xc1@3AAAAAAA\xc1\x80'
    b':\x81\x81\x94\x81\x81\x82\x81\xc1\xc0\x07\xc1\x0e\xc1\x81\x81'
    b'\x82\x83\x81\x82\x81A\x17A\x81\x86\x81\x81\x81\x81\x81\x81'
    b'\x81\x81\x81\x81\x92\x82\x82\x81\x81\x81A\x01\x10@,A'
    b'\x81\x81\x81\x81\x82\x81\x82\x81\x81\x16\x01\x81\x81\x88\x81\x81'
    b'\x81\x81\x81\x95\x82\x83\x81\x803\x81\x01\x11\x01\x81\xc0:'
    b'\xc1\xc2\xc2\xc1\xc4\x16@\x07A\xc1\xdc\xc1\xc7\xc3\xc1\xc1'
    b'\x80\x01\x81\x13\xc0,\xc1@:ADAD\x16\xc1A'
    b'VACCGABA\xc1\x14\x81AAABA'
    b'AC\x16\x803\x81AVACCHAA\x81\x01'
    b'\x14\x01\xc09\xc1AABACA\x15\x01\xc1AW'
    b'ABBIAA@\x07A\x16\x81\x80:\x81\x81\x82'
    b'\x81\x82\x81\x81\x15\x01\x81\x81\x97\x83\x81\x81\x89\x81\xc1\x01'
    b'\x16\xc03\xc1\x81\x83\x81\x82\x81@9A\x15\x80\x07\x81'
    b'\xc0:\xc1\xc1\xd6\xc1\xc3\xca\xc1\xc1@2A\x16\x01\x80'
    b'9\x81\xc1\xc1\xc2\xc1\xc2\xc1\xc03\xc1\x15@\x07A\x80'
    b':\x81\x9a\x81\x8a\x81\x81A\x16A\x81\x81\x82\x82\x82\x81'
    b'\xc0,\xc1\x15A\x81\xa5\x81\x81@\x01A\x16\x802\x81'
    b'\xc0:\xc1\xc1\xc1\xc1\xc2\xc1\xc1\xc1A\x15@+A\xc1'
    b'\xe5\xc1\x809\x81\x01\x15\x01\xc1\xc1\xc1\xc1\xc1\xc2\xc1\xc1'
    b'\xc03\xc1\x01\x15@,A\x80:\x81\xa5\x81\xc02\xc1'
    b'\x15\x01@3A\x81\x81\x83\x82\x81\x81\x80\x07\x81\x16\x81'
    b'\xc0:\xc1\xe5\xc1@+A\x15\x802\x81\xc1\xc3\xc2\xc1'
    b'\xc1\xc1\xc03\xc1\x01\x16@\x07A\x80:\x81\x81\xa4\x81'
    b'A\x13\x01\xc02\xc1\x81\x81\x82\x81\x81\x82\x81\x81A\x16'
    b'\x01@3A\x81\x81\x81\xa2\x81\x81\x80\x01\x81\x11\x81\xc0'
    b',\xc1@9A\x80:\x81\x81\x83\x81\x81\x82\x81\xc02'
    b'\xc1\x17@\x07A\x81\x81\x82\x81\xa1\x81\x81\x01\x0f\x01\xc1'
    b'\x81\x81\x81\x82\x81\x84\x81\x81\x803\x81\x01\x17\x81\xc0:'
    b'\xc1\xc1\xc2\xc1\xcb\xc1\xc1\xc1\xc2\xc1\xc1\xcf\xc1@9A'
    b'\x01\x0f\x802\x81\xc1\xc1\xc1\xc5\xc2\xc1\xc1\xc03\xc1\x01'
    b'\x18@:A\x809\x81\x81AAAIAAA\x81'
    b'\xc1\xc02\xc1\xc1@3A\x80:\x81\x81\x81\x8d\x81\xc0'
    b'9\xc1\x01\x0e\x01\xc1A@2A\x81\x81\x82\x81\x81\x81'
    b'\x81\x81\x803\x81\x01\x19\xc0:\xc1@\x07A\x802\x81'
    b'\xc1\xc1\xc1\xc8\xc1\xc1\x81A\x01\x04\x01\xc0,\xc1@9'
    b'A\x80:\x81\x81\x8b\x81\x81\x01\x0e\x01A\xc03\xc1@'
    b'2A\x81\x81\x81\x82\x81\x81\x81\xc1\x01\x1a\x81\x01\x80,'
    b'\x81\xc0:\xc1\xc2\xc1\xc6\xc1\xc1@\x07A\t\x01\x802'
    b'\x81\xc1\xc1\xca\xc1\xc1\xc0\x01\xc1\x0e\x01@9A\x803'
    b'\x81\xc02\xc1@:AABAAA\x80,\x81\x1c'
    b'\xc03\xc1\x01@\x07A\x80:\x81\x81\x81\x81\x85\x81\x81'
    b'A\x0c\xc02\xc1\x81\x8a\x81\x81A\x0f@3A\x81A'
    b'\x81\x81\x81\x81\x81\xc1\x01\x1d\x80\x08\x81\x01\x01\xc09\xc1'
    b'@:ABDB\x80\x07\x81\r\x01\xc03\xc1AJ'
    b'A@,A\x0f\x80\x01\x81\xc09\xc1@:AAA'
    b'\x803\x81\xc0,\xc1\x01\x1f\x02\x01@2A\x80:\x81'
    b'\x82\x81\x83\x81\xc03\xc1\x0f@\x01A\x81\x81\x89\x81\xc1'
    b'\x10\x01\x80\x08\x81\xc0\x07\xc1A\x01$\xc1@:AB'
    b'ABAA\xc1\x10\x802\x81AAGAA\xc09'
    b'\xc1\x01\n\x01-\x01\xc1AAAAAA\xc1\x01\x10'
    b'@\x07A\x80:\x81\x81\x81\x82\x82\x81\x81\x81\x81\x81A'
    b'9A\xc02\xc1@3AAAA\xc1\x80\x07\x81\x11'
    b'\x01\xc1A\xc0:\xc1\xc1\xc4\xc1\xc1A@2A\x81\x1b'
    b'\x03\r'
)

class NomieApp():
    """Nomie client app."""
    NAME = 'Nomie'
    ICON = nomie

    def foreground(self):
        """Activate the application."""
        self.db = (
                (icons.poop, "Pooped", "0", "#pooped"),
                (icons.toilet, "Peed", "0", "#peed"),
                # (icons.beer, "Beer", "2"),
                # (icons.muscle, "Push-ups", "2"),
                # (icons.water, "Water", "2"),
                # (icons.coffee, "Coffee", "2"),
                # (icons.mood, "Mood", "2"),
            )
        self.si = wasp.widgets.ScrollIndicator()
        self.card = wasp.widgets.NomieCard(None, "", "")
        self.page = 0

        self.update_card()

        self._draw()
        wasp.system.request_event(wasp.EventMask.TOUCH |
                                  wasp.EventMask.SWIPE_UPDOWN)

    def update_card(self):
        page = self.page
        pages = len(self.db)
        thing = self.db[self.page]
        self.card.icon = thing[0]
        self.card.title = thing[1]
        self.card.state = thing[2]
        self.card.is_first = page == 0
        self.card.is_last = page == pages-1

    def swipe(self, event):
        """Notify the application of a touchscreen swipe event."""
        pages = len(self.db)
        if event[0] == wasp.EventType.UP:
            if self.page == pages - 1:
                wasp.watch.vibrator.pulse()
            else:
                self.page = self.page + 1
                self.update_card()
                self._draw()
        elif event[0] == wasp.EventType.DOWN:
            if self.page == 0:
               wasp.watch.vibrator.pulse()
            else:
                self.page = self.page - 1
                self.update_card()
                self._draw()

    def touch(self, event):
        """Notify the application of a touchscreen touch event."""
        if self.card.touch(event):
            tracker = self.db[self.page]
            self._send_cmd('{"t":"nomie", "n":"' + tracker[3] + '"} ')
            # self.db[self.page][2] += "1"
            self.card.state = str(int(self.card.state) + 1)
            self.card.draw(all=False)
            # self.card.toggle()
            pass
            
    def _draw(self):
        """Draw the display from scratch."""
        # mute = wasp.watch.display.mute
        draw = wasp.watch.drawable

        # mute(True)
        draw.set_color(0x0000)
        draw.fill()
        self.si.draw()
        self.card.draw()
        # mute(False)


    def _send_cmd(self, cmd):
        print('\r')
        for i in range(1):
            for i in range(0, len(cmd), 20):
                print(cmd[i: i + 20], end='')
                time.sleep(0.2)
            print(' ')
        print(' ')